AWSTemplateFormatVersion: '2010-09-09'
Description: 'Demonstration of infrastructure as code by building a code pipeline from source'

# https://kbroman.org/github_tutorial/pages/init.html
# https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html
# https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line
# aws --profile adam-buglass-default cloudformation create-stack --stack-name demonstration --template-body file://./code-pipeline-stack.yaml
# aws --profile adam-buglass-default cloudformation create-stack --stack-name demonstration --template-body file://./code-pipeline-stack.yaml --capabilities CAPABILITY_IAM

Resources:

  # Stored in AWS SSM
  # GitHubOAuthToken:
  #   Type: AWS::SSM::Parameter
  #   Properties:
  #     Type: String
  #     Value: CodePipelineDemo
  # https://aws.amazon.com/blogs/mt/using-aws-systems-manager-parameter-store-secure-string-parameters-in-aws-cloudformation-templates/
  GitHubOAuthToken:
    Type: AWS::SSM::Parameter::Value::<String>
    Properties:
      Type: String
      Default: CodePipelineDemo

  # https://docs.aws.amazon.com/codepipeline/latest/userguide/pipelines-webhooks-create-cfn.html
  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-codepipeline-webhook-webhookauthconfiguration.html
  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-codepipeline-webhook-webhookfilterrule.html
  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codepipeline-webhook.html
  # https://docs.aws.amazon.com/codepipeline/latest/userguide/pipelines-webhooks-create.html

  Webhook:
    Type: AWS::CodePipeline::Webhook
    Properties:
      Name: DefaultWebhook
      Authentication: GITHUB_HMAC
      AuthenticationConfiguration:
        SecretToken: !Ref GitHubOAuthToken
      Filters:
        - JsonPath: '$.ref'
          MatchEquals: !Sub refs/heads/master
      TargetAction: UpdateFromSource
      TargetPipeline: !Ref CodePipeline
      TargetPipelineVersion: !GetAtt CodePipeline.Version
      RegisterWithThirdParty: true

  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html
  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-policy.html
  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Principal:
              Service:
                - 'codepipeline.amazonaws.com'
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        -
          PolicyName: "demonstration"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              -
                Effect: "Allow"
                Action: "*" # NO!
                Resource: "*" # NO!

  CodePipelineArtifactStore:
    Type: AWS::S3::Bucket

  DefaultCodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Principal:
              Service:
                - 'codebuild.amazonaws.com'
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        -
          PolicyName: "demonstration"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              -
                Effect: "Allow"
                Action: "*" # NO!
                Resource: "*" # NO!

  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codebuild-project.html
  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codebuild-project.html#cfn-codebuild-project-artifacts
  DefaultCodeBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:2.0
        Type: LINUX_CONTAINER
      ServiceRole: !GetAtt DefaultCodeBuildRole.Arn
      Source:
        BuildSpec: source/buildspec.yml
        Type: CODEPIPELINE

  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-getatt.html
  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-codepipeline-pipeline-artifactstore.html
  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-ref.html
  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-getatt.html
  # https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-pipeline-structure.html#structure-configuration-examples

  CodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: DefaultPipeline
      RoleArn: !GetAtt CodePipelineRole.Arn
      ArtifactStore:
        Location: !Ref CodePipelineArtifactStore
        Type: S3
      Stages:

      - Name: Source
        Actions:
        -
          Name: UpdateFromSource
          ActionTypeId:
            Category: Source
            Owner: ThirdParty
            Provider: GitHub
            Version: 1
          OutputArtifacts:
            - Name: SourceOutput
          Configuration:
            Owner: buglass
            Repo: aws-introduction
            Branch: master
            OAuthToken: !Ref GitHubOAuthToken
            PollForSourceChanges: false
          RunOrder: 1

      # https://docs.aws.amazon.com/codepipeline/latest/userguide/pipelines-create.html
      # https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-pipeline-structure.html
      # https://docs.aws.amazon.com/codebuild/latest/userguide/how-to-create-pipeline.html#pipelines-create-console
      # https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-pipeline-structure.html#structure-configuration-examples
      # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codebuild-project.html
      - Name: Build
        Actions:
        -
          Name: BuildLambda
          ActionTypeId:
            Category: Build
            Owner: AWS
            Provider: CodeBuild
            Version: 1
          InputArtifacts:
            - Name: SourceOutput
          Configuration:
            ProjectName: !Ref DefaultCodeBuild
          RunOrder: 1